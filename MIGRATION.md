# バージョン移行マッピング

このドキュメントは、dotfiles プロジェクトの旧バージョン体系から新しいセマンティックバージョニング 0.x.x への完全な移行マッピングを記録します。

## 移行の背景

このプロジェクトは複数のバージョニング体系を経て進化してきました：

1. **Phase 1 (初期 SemVer 期)**: 適切なセマンティックバージョニング（1.0.0 → 2.3.0）
2. **Phase 2 (単純バージョン期)**: パッチバージョンを省略（3.0 → 9.0）
3. **Phase 3 (v プレフィックス期)**: v プレフィックス付き（v10.0 → v18.0）

これらを統一された 0.x.x 形式に移行することで、一貫性のあるバージョン管理を実現します。

## 移行方針

- **MINOR**: 時系列順に連番（0.1.0, 0.2.0, 0.3.0...）
- **PATCH**: 元のバージョンの PATCH 番号を保持（1.2.1 → 0.3.1）
- **最終バージョン**: v18.0 → 0.28.0

## 完全な対応表

全てのバージョンを時系列順に 0.x.x 形式に変換します。MINOR バージョンは時系列順に連番、PATCH バージョンは元の番号を保持します。

| 旧タグ | 新タグ | リリース日 | 備考                 |
| ------ | ------ | ---------- | -------------------- |
| 1.0.0  | 0.1.0  | 2018-06-07 | 初期リリース         |
| 1.1.0  | 0.2.0  | 2018-06-26 |                      |
| 1.1.1  | 0.2.1  | 2018-06-27 | PATCH 保持           |
| 1.2.0  | 0.3.0  | 2018-07-10 |                      |
| 1.2.1  | 0.3.1  | 2018-07-17 | PATCH 保持           |
| 1.2.2  | 0.3.2  | 2018-07-17 | PATCH 保持           |
| 1.2.3  | 0.3.3  | 2019-05-01 | PATCH 保持           |
| 1.3.0  | 0.4.0  | 2020-04-18 |                      |
| 1.4.0  | 0.5.0  | 2020-04-19 |                      |
| 1.5.0  | 0.6.0  | 2020-04-27 |                      |
| 1.5.1  | 0.6.1  | 2020-04-29 | PATCH 保持           |
| 1.5.2  | 0.6.2  | 2020-05-02 | PATCH 保持           |
| 1.6.0  | 0.7.0  | 2020-05-04 |                      |
| 1.6.1  | 0.7.1  | 2020-05-04 | PATCH 保持           |
| 1.6.2  | 0.7.2  | 2020-05-04 | PATCH 保持           |
| 1.6.3  | 0.7.3  | 2020-05-04 | PATCH 保持           |
| 1.6.4  | 0.7.4  | 2020-05-16 | PATCH 保持           |
| 1.6.5  | 0.7.5  | 2020-05-21 | PATCH 保持           |
| 1.6.6  | 0.7.6  | 2020-05-21 | PATCH 保持           |
| 1.6.7  | 0.7.7  | 2020-05-24 | PATCH 保持           |
| 1.7.0  | 0.8.0  | 2020-09-12 |                      |
| 1.7.1  | 0.8.1  | 2020-09-12 | PATCH 保持           |
| 2.0.0  | 0.9.0  | 2020-11-01 |                      |
| 2.1.0  | 0.10.0 | 2020-11-02 |                      |
| 2.1.1  | 0.10.1 | 2021-03-08 | PATCH 保持           |
| 2.2.0  | 0.11.0 | 2021-03-13 |                      |
| 2.2.1  | 0.11.1 | 2021-03-20 | PATCH 保持           |
| 2.2.2  | 0.11.2 | 2021-03-20 | PATCH 保持           |
| 2.3.0  | 0.12.0 | 2021-04-04 |                      |
| 3.0    | 0.13.0 | 2021-04-11 |                      |
| 4.0    | 0.14.0 | 2021-04-11 |                      |
| 5.0    | 0.15.0 | 2021-04-11 |                      |
| 6.0    | 0.16.0 | 2021-04-13 |                      |
| 7.0    | 0.17.0 | 2021-04-15 |                      |
| 8.0    | 0.18.0 | 2021-04-18 |                      |
| 8.1    | 0.18.1 | 2021-04-20 | PATCH 保持           |
| 8.2    | 0.18.2 | 2021-04-20 | PATCH 保持           |
| 8.3    | 0.18.3 | 2021-04-21 | PATCH 保持           |
| 8.4    | 0.18.4 | 2021-06-22 | PATCH 保持           |
| 9.0    | 0.19.0 | 2021-06-28 |                      |
| v10.0  | 0.20.0 | 2021-07-02 | v プレフィックス削除 |
| v11.0  | 0.21.0 | 2023-08-20 |                      |
| v12.0  | 0.22.0 | 2023-09-02 |                      |
| v13.0  | 0.23.0 | 2023-09-09 |                      |
| v14.0  | 0.24.0 | 2023-09-11 |                      |
| v14.1  | 0.24.1 | 2023-09-12 | PATCH 保持           |
| v14.2  | 0.24.2 | 2024-01-08 | PATCH 保持           |
| v15.0  | 0.25.0 | 2024-01-08 |                      |
| v16.0  | 0.26.0 | 2024-05-13 |                      |
| v17.0  | 0.27.0 | 2024-08-24 |                      |
| v18.0  | 0.28.0 | 2024-10-04 | 最新バージョン       |

## 移行の原則

### 1. 時系列の保持

全てのバージョンは、元のリリース順序を保持しています。

### 2. コミットの保持

全ての新しいタグは、元のタグと同じ Git コミットを参照します。履歴は変更されません。

### 3. リリースノートの保持

GitHub リリースに記載されていた全てのリリースノートは、新しいリリースに移行されます。

### 4. アセットの保持

リリースに添付されていたファイル（アセット）も、可能な限り新しいリリースに移行されます。

## 移行スクリプト

移行は以下のスクリプトを使用して実行されます：

### 事前確認（ドライラン）

実際の変更を行う前に、ドライランモードで確認することを強く推奨します：

```bash
# ドライラン実行（変更なし）
./migrate-to-semver-0x.sh --dry-run

# 出力例：
# [DRY RUN] Would create tag 0.1.0
# [DRY RUN] Would migrate release
# [DRY RUN] Would delete old tag 1.0.0
```

### 本番実行

ドライランで問題がないことを確認してから実行：

```bash
# 自動バックアップ付きで実行（推奨）
./migrate-to-semver-0x.sh

# バックアップなしで実行（非推奨）
./migrate-to-semver-0x.sh --no-backup
```

### 品質担保機能

1. **自動バックアップ**: タグとリリース情報を`migration-backup/`に保存
2. **ドライランモード**: 実際の変更前に動作を確認
3. **エラーハンドリング**: 失敗時の統計情報を表示
4. **ロールバックスクリプト**: `rollback-migration.sh`で復元可能

### 現在のタグの確認

```bash
# 現在のタグ確認
git tag -l | sort -V

# 現在のリリース確認
gh release list --repo toshiki670/dotfiles
```

## 移行後の確認

移行が正常に完了したことを確認するには：

```bash
# タグ数の確認（52個のタグがあるはず）
git tag -l | wc -l

# タグ一覧の表示
git tag -l | sort -V

# 最新バージョンの確認（0.28.0のはず）
git tag -l | sort -V | tail -1

# GitHubリリースの確認
gh release list --repo toshiki670/dotfiles

# バージョンファイルの更新
echo '0.28.0' > version
git add version
git commit -m "chore: update version to 0.28.0 (post-migration)"
git push
```

## 品質担保

### テスト手順

移行前に以下の手順でテストすることを推奨します：

#### 1. ドライラン実行

```bash
./migrate-to-semver-0x.sh --dry-run
```

出力を確認：
- すべてのタグが正しくマッピングされているか
- 欠損しているタグはないか
- 警告やエラーが表示されていないか

#### 2. バックアップの確認

```bash
# バックアップディレクトリの作成を確認
ls -la migration-backup/

# 以下のファイルが存在することを確認：
# - tags_backup_<timestamp>.txt
# - releases_backup_<timestamp>.txt
# - mapping_<timestamp>.txt
```

#### 3. Git の状態確認

```bash
# 未コミットの変更がないことを確認
git status

# 現在のブランチを確認
git branch --show-current

# リモートと同期していることを確認
git fetch
git status
```

#### 4. 権限確認

```bash
# GitHub CLI の認証状態を確認
gh auth status

# リポジトリへのアクセス権限を確認
gh repo view toshiki670/dotfiles
```

### 失敗時の対応

#### ケース1: ネットワークエラー

```bash
# ネットワーク接続を確認
ping github.com

# GitHub の状態を確認
curl -s https://www.githubstatus.com/api/v2/status.json | jq

# 再実行
./migrate-to-semver-0x.sh
```

#### ケース2: 認証エラー

```bash
# 再認証
gh auth login

# トークンの権限を確認（repo権限が必要）
gh auth status
```

#### ケース3: 部分的な失敗

スクリプトが途中で停止した場合：

```bash
# 1. 現在の状態を確認
git tag -l | grep -E '^0\.[0-9]+\.[0-9]+$'

# 2. 新しく作成されたタグを削除
./rollback-migration.sh

# 3. 問題を解決してから再実行
./migrate-to-semver-0x.sh
```

### 検証チェックリスト

移行後に以下を確認：

- [ ] タグ数が52個である
- [ ] 最新タグが`0.28.0`である
- [ ] すべてのタグが`0.x.x`形式である
- [ ] 古い形式のタグ（`1.0.0`, `v10.0`など）が存在しない
- [ ] GitHubリリースが52個存在する
- [ ] すべてのリリースが`0.x.x`形式である
- [ ] リリースノートが保持されている
- [ ] バージョンファイルが`0.28.0`を指している
- [ ] バックアップが`migration-backup/`に存在する

## ロールバック

万が一、移行に問題があった場合のロールバック手順：

### 自動バックアップからの復元

移行スクリプトは自動的にバックアップを作成します（`migration-backup/`ディレクトリ）。

```bash
# バックアップの確認
ls -la migration-backup/

# ロールバックスクリプトを実行
./rollback-migration.sh

# 以下の手順を実行：
# 1. 0.x.x タグを全て削除
# 2. 元のタグを復元（制限付き）
# 3. GitHub リリースは手動で削除が必要
```

### 手動でのロールバック

#### 1. 新しいタグの削除

```bash
# 0.x.x 形式のタグを全て削除
for tag in $(git tag -l | grep -E '^0\.[0-9]+\.[0-9]+$'); do
    echo "Deleting: $tag"
    git tag -d "$tag"
    git push origin ":refs/tags/$tag"
done
```

#### 2. 元のタグの復元

残念ながら、削除されたタグを自動的に復元することはできません。以下の方法で手動復元が必要です：

```bash
# 1. バックアップファイルを確認
cat migration-backup/tags_backup_*.txt

# 2. Git reflog から元のコミットを見つける
git reflog | grep "tag:"

# 3. 元のコミットハッシュでタグを再作成
git tag -a <tag-name> <commit-hash> -m "<message>"
git push origin <tag-name>
```

#### 3. GitHub リリースのクリーンアップ

```bash
# 0.x.x リリースを削除
gh release list --repo toshiki670/dotfiles
gh release delete <version> --repo toshiki670/dotfiles --yes
```

### 部分的な失敗からの復旧

移行が途中で失敗した場合：

```bash
# 1. 現在の状態を確認
git tag -l | sort -V

# 2. 成功した分の新しいタグと古いタグが混在している場合
# 新しいタグを削除して再実行
for tag in $(git tag -l | grep -E '^0\.[0-9]+\.[0-9]+$'); do
    git tag -d "$tag"
    git push origin ":refs/tags/$tag"
done

# 3. 移行スクリプトを再実行
./migrate-to-semver-0x.sh
```

### 連絡先

復旧が困難な場合：
- GitHub サポートに連絡
- バックアップから手動で復元
- Issue を作成: https://github.com/toshiki670/dotfiles/issues

## 参考情報

- [VERSIONING.md](./VERSIONING.md) - バージョニングルールの詳細
- [Semantic Versioning 2.0.0](https://semver.org/)
- [GitHub Releases](https://docs.github.com/en/repositories/releasing-projects-on-github)

## 移行完了日

- 移行日: TBD
- 移行者: TBD
- 移行スクリプトバージョン: 1.0.0
